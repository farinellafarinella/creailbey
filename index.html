<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Crea il tuo bey</title>
  <style>
    :root {
      --bg: #0b0b0b;
      --card: #121212;
      --text: #f5f5f5;
      --muted: #b5b5b5;
      --accent: #e10600;
      --border: rgba(255, 255, 255, 0.12);
      --shadow: 0 18px 40px rgba(0, 0, 0, 0.45);
      --radius: 18px;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: "Work Sans", system-ui, sans-serif;
      background: radial-gradient(circle at top left, #1a1a1a, #0b0b0b 60%, #050505 100%);
      color: var(--text);
      min-height: 100vh;
      padding: 32px 6vw 60px;
    }

    header {
      margin-bottom: 24px;
    }

    .header-row {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 16px;
    }

    .header-nav a {
      color: #0a0a0a;
      text-decoration: none;
      font-weight: 800;
      font-size: 1.1rem;
      background: var(--accent);
      padding: 12px 20px;
      border-radius: 999px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 10px 22px rgba(255, 45, 45, 0.28);
    }

    .header-nav a:hover {
      transform: translateY(-1px);
      box-shadow: 0 12px 26px rgba(255, 45, 45, 0.38);
    }

    h1 {
      font-size: clamp(2rem, 5vw, 3rem);
      margin-bottom: 8px;
    }

    .muted {
      color: var(--muted);
    }

    .layout {
      display: grid;
      grid-template-columns: minmax(240px, 1fr) minmax(260px, 1fr);
      gap: 24px;
    }

    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 22px;
      box-shadow: var(--shadow);
    }

    form {
      display: grid;
      gap: 12px;
    }

    label {
      display: grid;
      gap: 6px;
      font-weight: 600;
    }

    select {
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 12px;
      padding: 12px 14px;
      background: #0b0b0b;
      color: var(--text);
      font-size: 1rem;
    }

    button {
      border: none;
      border-radius: 999px;
      padding: 12px 18px;
      background: linear-gradient(135deg, var(--accent), #8d0000);
      color: #fff;
      font-weight: 700;
      font-size: 1rem;
      cursor: pointer;
      width: fit-content;
    }

    .result-list {
      display: grid;
      gap: 10px;
      margin-top: 14px;
    }

    .result-pill {
      padding: 10px 12px;
      border-radius: 12px;
      background: rgba(255, 255, 255, 0.08);
      font-weight: 600;
    }

    .part-icon {
      width: 36px;
      height: 36px;
      border-radius: 10px;
      object-fit: contain;
      background: rgba(255, 255, 255, 0.06);
      border: 1px solid var(--border);
      padding: 4px;
    }

    .part-row {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .result-row {
      display: flex;
      gap: 12px;
      align-items: center;
    }

    .result-meta {
      display: grid;
      gap: 4px;
    }

    .preview-row {
      display: flex;
      gap: 12px;
      align-items: center;
      margin-top: 6px;
    }

    .preview-img {
      width: 72px;
      height: 72px;
      border-radius: 14px;
      object-fit: contain;
      background: rgba(255, 255, 255, 0.06);
      border: 1px solid var(--border);
      padding: 6px;
      display: none;
    }

    .preview-img.active {
      display: inline-block;
    }

    .pill-note {
      display: block;
      font-weight: 400;
      color: var(--muted);
      font-size: 0.85rem;
      margin-top: 4px;
    }

    .result-combo {
      margin-top: 18px;
    }

    .combo-title {
      font-weight: 700;
      color: var(--accent);
    }

    .result-link {
      display: inline-block;
      margin-top: 6px;
      color: #25d366;
      text-decoration: none;
      font-weight: 700;
    }

    .result-link:hover {
      color: #1ebe5d;
    }

    .auth-card {
      margin-bottom: 24px;
    }

    .auth-top {
      margin-top: 18px;
      margin-left: auto;
      max-width: 520px;
    }

    .auth-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 16px;
      margin-top: 12px;
    }

    .auth-row {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 10px;
    }

    input {
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 12px;
      padding: 12px 14px;
      background: #0b0b0b;
      color: var(--text);
      font-size: 1rem;
    }

    button.secondary {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--text);
    }

    .auth-card button {
      min-width: 120px;
    }

    .is-hidden {
      display: none;
    }

    .toggle {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      font-weight: 600;
      margin-bottom: 12px;
    }

    .switch {
      position: relative;
      display: inline-block;
      width: 52px;
      height: 28px;
      flex-shrink: 0;
    }

    .switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .slider {
      position: absolute;
      cursor: pointer;
      inset: 0;
      background: #2a2a2a;
      transition: 0.2s ease;
      border-radius: 999px;
    }

    .slider::before {
      position: absolute;
      content: "";
      height: 22px;
      width: 22px;
      left: 3px;
      top: 3px;
      background: #ffffff;
      transition: 0.2s ease;
      border-radius: 50%;
    }

    .switch input:checked + .slider {
      background: var(--accent);
    }

    .switch input:checked + .slider::before {
      transform: translateX(24px);
    }

    .is-hidden {
      display: none;
    }

    @media (max-width: 720px) {
      .header-row {
        flex-direction: column;
        align-items: flex-start;
      }

      .auth-card button {
        width: 100%;
      }

      .layout {
        grid-template-columns: 1fr;
      }

      button {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <header>
    <div class="header-row">
      <div>
        <h1>Crea il tuo bey</h1>
        <p class="muted">Scegli lama, ratchet e punta. Ti diciamo cosa comprare (max 3 bey).</p>
      </div>
      <nav class="header-nav">
        <a href="community.html">Community build</a>
      </nav>
    </div>
    <section class="card auth-card auth-top" id="home-auth">
      <h2>Accesso</h2>
      <p class="muted">Accedi per usare Community build. Solo email + password.</p>
      <div class="auth-grid">
        <form id="email-form">
          <label>
            Email
            <input type="email" id="email-input" placeholder="nome@email.it" required />
          </label>
          <label>
            Password
            <input type="password" id="password-input" placeholder="Min 6 caratteri" required />
          </label>
          <div class="auth-row">
            <button type="submit">Accedi</button>
            <button type="button" class="secondary" id="email-register">Registrati</button>
          </div>
        </form>
      </div>
      <div class="auth-row">
        <button type="button" class="secondary is-hidden" id="logout-btn">Logout</button>
      </div>
      <p class="muted" id="auth-message"></p>
    </section>
  </header>

  <main class="layout">
    <form class="card" id="bey-form">
      <label class="toggle">
        <span>Voglio comporre un CX (Assist blade)</span>
        <span class="switch">
          <input type="checkbox" id="cx-toggle" />
          <span class="slider"></span>
        </span>
      </label>
      <label>
        Lama
        <select id="blade-select">
          <option value="">Seleziona la lama</option>
        </select>
        <div class="preview-row">
          <img class="preview-img" id="blade-preview" alt="Anteprima lama" />
        </div>
      </label>
      <label id="assist-field" class="is-hidden">
        Assist blade (CX)
        <select id="assist-select">
          <option value="">Seleziona la assist blade</option>
        </select>
      </label>
      <label>
        Ratchet
        <select id="ratchet-select">
          <option value="">Seleziona il ratchet</option>
        </select>
        <div class="preview-row">
          <img class="preview-img" id="ratchet-preview" alt="Anteprima ratchet" />
        </div>
      </label>
      <label>
        Punta
        <select id="bit-select">
          <option value="">Seleziona la punta</option>
        </select>
        <div class="preview-row">
          <img class="preview-img" id="bit-preview" alt="Anteprima punta" />
        </div>
      </label>
      <button type="submit">Trova i bey da comprare</button>
      <p class="muted">Esempio: Lama = Keel Shark, Ratchet = 1-60, Punta = T (Taper).</p>
    </form>

    <div class="card" id="bey-results">
      <h2>Risultato</h2>
      <p class="muted">Compila i campi per vedere la lista degli acquisti consigliati.</p>
    </div>
  </main>

  <script>
    const productLinks = {
      "Sword Dran (F9580)":
        "https://www.amazon.it/Beyblade-Starter-Pack-trottola-lanciatore/dp/B0CS8L1HGM?utm_source=chatgpt.com",
      "Helm Knight (F9581)":
        "https://www.amazon.it/Beyblade-Starter-Pack-Confezione-lanciatore/dp/B0CS89NLVK?utm_source=chatgpt.com",
      "Arrow Wizard (F9582)":
        "https://www.amazon.it/beyblade-x-starter-pack/s?k=beyblade+x+starter+pack&utm_source=chatgpt.com",
      "Scythe Incendio (F9583)":
        "https://www.amazon.it/beyblade-x-starter-pack/s?k=beyblade+x+starter+pack&utm_source=chatgpt.com",
      "Lance Knight (G0184)":
        "https://www.amazon.it/beyblade-x-starter-pack/s?k=beyblade+x+starter+pack&utm_source=chatgpt.com",
      "Claw Leon (G0193)":
        "https://www.amazon.it/beyblade-x-starter-pack/s?k=beyblade+x+starter+pack&utm_source=chatgpt.com",
      "Buster Dran (G1536)":
        "https://www.amazon.it/beyblade-x-starter-pack/s?k=beyblade+x+starter+pack&utm_source=chatgpt.com",
      "Wand Wizard (G1537)":
        "https://www.amazon.it/beyblade-x-starter-pack/s?k=beyblade+x+starter+pack&utm_source=chatgpt.com",
      "Wand Wizard (G1538)":
        "https://www.amazon.it/beyblade-x-starter-pack/s?k=beyblade+x+starter+pack&utm_source=chatgpt.com",
      "Shadow Shinobi (G1539)":
        "https://www.amazon.it/beyblade-x-starter-pack/s?k=beyblade+x+starter+pack&utm_source=chatgpt.com",
      "Scarlet Garuda (G1673)":
        "https://www.amazon.it/beyblade-x-starter-pack/s?k=beyblade+x+starter+pack&utm_source=chatgpt.com",
      "Sterling Wolf (G1674)":
        "https://www.amazon.it/beyblade-x-starter-pack/s?k=beyblade+x+starter+pack&utm_source=chatgpt.com",
      "Shelter Drake (G1675)":
        "https://www.amazon.it/beyblade-x-starter-pack/s?k=beyblade+x+starter+pack&utm_source=chatgpt.com",
      "Rock Golem (G1676)":
        "https://www.amazon.it/beyblade-x-starter-pack/s?k=beyblade+x+starter+pack&utm_source=chatgpt.com",
      "Buster Dran (G1751)":
        "https://www.amazon.it/beyblade-x-starter-pack/s?k=beyblade+x+starter+pack&utm_source=chatgpt.com",
      "Hammer Incendio (G1752)":
        "https://www.amazon.it/beyblade-x-starter-pack/s?k=beyblade+x+starter+pack&utm_source=chatgpt.com",
      "Stun Medusa (G2738)":
        "https://www.amazon.it/beyblade-x-starter-pack/s?k=beyblade+x+starter+pack&utm_source=chatgpt.com",
      "Rudder Phoenix (G2739)":
        "https://www.amazon.it/beyblade-x-starter-pack/s?k=beyblade+x+starter+pack&utm_source=chatgpt.com",
      "Feather Phoenix (G2740)":
        "https://www.amazon.it/beyblade-x-starter-pack/s?k=beyblade+x+starter+pack&utm_source=chatgpt.com",
      "Courage Dran S (G1677)":
        "https://www.amazon.it/beyblade-x-starter-pack/s?k=beyblade+x+starter+pack&utm_source=chatgpt.com",
      "Reaper Incendio T (G1678)":
        "https://www.amazon.it/beyblade-x-starter-pack/s?k=beyblade+x+starter+pack&utm_source=chatgpt.com",
      "Arc Wizard R (G1679)":
        "https://www.amazon.it/beyblade-x-starter-pack/s?k=beyblade+x+starter+pack&utm_source=chatgpt.com",
      "Dark Perseus B (G1680)":
        "https://www.amazon.it/beyblade-x-starter-pack/s?k=beyblade+x+starter+pack&utm_source=chatgpt.com",
      "Brush Fox J (G1681)":
        "https://www.amazon.it/beyblade-x-starter-pack/s?k=beyblade+x+starter+pack&utm_source=chatgpt.com",
      "Fort Hornet R (G1682)":
        "https://www.amazon.it/beyblade-x-starter-pack/s?k=beyblade+x+starter+pack&utm_source=chatgpt.com",
      "Wriggle Kraken S (G1683)":
        "https://www.amazon.it/beyblade-x-starter-pack/s?k=beyblade+x+starter+pack&utm_source=chatgpt.com",
      "Antler Stag B (G1684)":
        "https://www.amazon.it/beyblade-x-starter-pack/s?k=beyblade+x+starter+pack&utm_source=chatgpt.com",
      "Steel Samurai (G0188)":
        "https://www.amazon.it/beyblade-x-starter-pack/s?k=beyblade+x+starter+pack&utm_source=chatgpt.com",
      "Horn Rhino (G0192)":
        "https://www.amazon.it/beyblade-x-starter-pack/s?k=beyblade+x+starter+pack&utm_source=chatgpt.com",
      "Keel Shark (G0194)":
        "https://www.amazon.it/beyblade-x-starter-pack/s?k=beyblade+x+starter+pack&utm_source=chatgpt.com",
      "Talon Ptera (G0195)":
        "https://www.amazon.it/beyblade-x-starter-pack/s?k=beyblade+x+starter+pack&utm_source=chatgpt.com",
      "Sting Unicorn (G0283)":
        "https://www.amazon.it/beyblade-x-starter-pack/s?k=beyblade+x+starter+pack&utm_source=chatgpt.com",
      "Roar Tyranno (G0284)":
        "https://www.amazon.it/beyblade-x-starter-pack/s?k=beyblade+x+starter+pack&utm_source=chatgpt.com",
      "Scythe Incendio (G0285)":
        "https://www.amazon.it/beyblade-x-starter-pack/s?k=beyblade+x+starter+pack&utm_source=chatgpt.com",
      "Savage Bear (G0286)":
        "https://www.amazon.it/beyblade-x-starter-pack/s?k=beyblade+x+starter+pack&utm_source=chatgpt.com",
      "Cowl Sphinx (G1530)":
        "https://www.amazon.it/beyblade-x-starter-pack/s?k=beyblade+x+starter+pack&utm_source=chatgpt.com",
      "Arrow Wizard (G1531)":
        "https://www.amazon.it/beyblade-x-starter-pack/s?k=beyblade+x+starter+pack&utm_source=chatgpt.com",
      "Obsidian Shell (G1533)":
        "https://www.amazon.it/beyblade-x-starter-pack/s?k=beyblade+x+starter+pack&utm_source=chatgpt.com",
      "Keel Shark (G1534)":
        "https://www.amazon.it/beyblade-x-starter-pack/s?k=beyblade+x+starter+pack&utm_source=chatgpt.com",
      "Tide Whale (G1669)":
        "https://www.amazon.it/beyblade-x-starter-pack/s?k=beyblade+x+starter+pack&utm_source=chatgpt.com",
      "Dagger Dran (G1670)":
        "https://www.amazon.it/beyblade-x-starter-pack/s?k=beyblade+x+starter+pack&utm_source=chatgpt.com",
      "Lance Knight (G1671)":
        "https://www.amazon.it/beyblade-x-starter-pack/s?k=beyblade+x+starter+pack&utm_source=chatgpt.com",
      "Yell Kong (G1754)":
        "https://www.amazon.it/beyblade-x-starter-pack/s?k=beyblade+x+starter+pack&utm_source=chatgpt.com",
      "Arrow Wizard (G1755)":
        "https://www.amazon.it/beyblade-x-starter-pack/s?k=beyblade+x+starter+pack&utm_source=chatgpt.com",
      "Soar Phoenix (G1756)":
        "https://www.amazon.it/beyblade-x-starter-pack/s?k=beyblade+x+starter+pack&utm_source=chatgpt.com",
      "Chain Incendio & Arrow Wizard (Dual Pack)":
        "https://www.amazon.it/beyblade-x-dual-pack/s?k=beyblade+x+dual+pack&utm_source=chatgpt.com",
      "Knife Shinobi & Keel Shark (Dual Pack)":
        "https://www.amazon.it/beyblade-x-dual-pack/s?k=beyblade+x+dual+pack&utm_source=chatgpt.com",
      "Yell Kong & Helm Knight (Dual Pack)":
        "https://www.amazon.it/beyblade-x-dual-pack/s?k=beyblade+x+dual+pack&utm_source=chatgpt.com",
      "Pearl Tiger & Gill Shark (Dual Pack)":
        "https://www.amazon.it/beyblade-x-dual-pack/s?k=beyblade+x+dual+pack&utm_source=chatgpt.com",
      "Circle Ghost & Chain Incendio (Dual Pack)":
        "https://www.amazon.it/beyblade-x-dual-pack/s?k=beyblade+x+dual+pack&utm_source=chatgpt.com",
      "Hack Viking & Circle Ghost (Dual Pack)":
        "https://www.amazon.it/beyblade-x-dual-pack/s?k=beyblade+x+dual+pack&utm_source=chatgpt.com",
      "Drop Attack Battle Set (G0842)":
        "https://www.amazon.it/beyblade-x-starter-pack/s?k=beyblade+x+starter+pack&utm_source=chatgpt.com",
      "Dual Pack (Amazon)":
        "https://www.amazon.it/s?k=beyblade+x+dual+pack",
      "Iron Man & Thanos (Dual Pack)":
        "https://www.amazon.it/s?k=beyblade+x+iron+man+thanos+dual+pack",
      "Spider-Man & Venom (Dual Pack)":
        "https://www.amazon.it/s?k=beyblade+x+spider-man+venom+dual+pack",
      "Optimus Prime & Megatron (Dual Pack)":
        "https://www.amazon.it/s?k=beyblade+x+optimus+prime+megatron+dual+pack",
      "Optimus Primal & Starscream (Dual Pack)":
        "https://www.amazon.it/s?k=beyblade+x+optimus+primal+starscream+dual+pack",
      "Mandolorian & Moff Gideon (Dual Pack)":
        "https://www.amazon.it/s?k=beyblade+x+mandalorian+moff+gideon+dual+pack",
      "Luke Skywalker & Darth Vader (Dual Pack)":
        "https://www.amazon.it/s?k=beyblade+x+luke+skywalker+darth+vader+dual+pack",
      "T-Rex & Mosasaurus (Dual Pack)":
        "https://www.amazon.it/s?k=beyblade+x+t-rex+mosasaurus+dual+pack",
      "Spinosaurus & Quetzalcoatlus (Dual Pack)":
        "https://www.amazon.it/s?k=beyblade+x+spinosaurus+quetzalcoatlus+dual+pack",
    };

    const bladeImages = {
      "Antler Stag B": "images/blades/antler_stag_b.png",
      "Arc Wizard R": "images/blades/arc_wizard_r.png",
      "Arrow Wizard": "images/blades/arrow_wizard.png",
      "Brush Fox J": "images/blades/brush_fox_j.png",
      "Buster Dran": "images/blades/buster_dran.png",
      "Chain Incendio": "images/blades/chain_incendio.png",
      "Circle Ghost": "images/blades/circle_ghost.png",
      "Claw Leon": "images/blades/claw_leon.png",
      "Courage Dran S": "images/blades/courage_dran_s.png",
      "Cowl Sphinx": "images/blades/cowl_sphinx.png",
      "Dark Perseus B": "images/blades/dark_perseus_b.png",
      "Dagger Dran": "images/blades/dagger_dran.png",
      "Sword Dran": "images/blades/sword_dran.png",
      "Feather Phoenix": "images/blades/feather_phoenix.png",
      "Fort Hornet R": "images/blades/fort_hornet_r.png",
      "Gill Shark": "images/blades/gill_shark.png",
      "Hammer Incendio": "images/blades/hammer_incendio.png",
      "Helm Knight": "images/blades/helm_knight.png",
      "Horn Rhino": "images/blades/horn_rhino.png",
      "Hover Wyvern": "images/blades/hover_wyvern.png",
      "Impact Drake": "images/blades/impact_drake.png",
      "Keel Shark": "images/blades/keel_shark.png",
      "Knife Shinobi": "images/blades/knife_shinobi.png",
      "Lance Knight": "images/blades/lance_knight.png",
      "Obsidian Shell": "images/blades/obsidian_shell.png",
      "Pearl Tiger": "images/blades/pearl_tiger.png",
      "Reaper Incendio T": "images/blades/reaper_incendio_t.png",
      "Roar Tyranno": "images/blades/roar_tyranno.png",
      "Rock Golem": "images/blades/rock_golem.png",
      "Rudder Phoenix": "images/blades/rudder_phoenix.png",
      "Savage Bear": "images/blades/savage_bear.png",
      "Scarlet Garuda": "images/blades/scarlet_garuda.png",
      "Scythe Incendio": "images/blades/scythe_incendio.png",
      "Shadow Shinobi": "images/blades/shadow_shinobi.png",
      "Shelter Drake": "images/blades/shelter_drake.png",
      "Soar Phoenix": "images/blades/soar_phoenix.png",
      "Steel Samurai": "images/blades/steel_samurai.png",
      "Sterling Wolf": "images/blades/sterling_wolf.png",
      "Sting Unicorn": "images/blades/sting_unicorn.png",
      "Stun Medusa": "images/blades/stun_medusa.png",
      "Talon Ptera": "images/blades/talon_ptera.png",
      "Tide Whale": "images/blades/tide_whale.png",
      "Wand Wizard": "images/blades/wand_wizard.png",
      "Wriggle Kraken S": "images/blades/wriggle_kraken_s.png",
      "Yell Kong": "images/blades/yell_kong.png"
    };

    const storageBase =
      "https://firebasestorage.googleapis.com/v0/b/progettobey.firebasestorage.app/o/";
    const storageUrl = (path) =>
      `${storageBase}${encodeURIComponent(path)}?alt=media`;
    const normalizeImagePath = (path) =>
      path.replace(/^images\//i, "IMAGES/");
    const bladeImage = (blade) =>
      bladeImages[blade] ? storageUrl(normalizeImagePath(bladeImages[blade])) : "";
    const ratchetImage = (ratchet) =>
      ratchet ? storageUrl(`IMAGES/ratchet/${ratchet}.png`) : "";
    const bitImage = (bit) =>
      bit ? storageUrl(`IMAGES/bit/${bit}.png`) : "";

    const products = [
      {
        name: "Iron Man & Thanos (Dual Pack)",
        beys: [
          { blade: "Iron Man", ratchet: "4-80", bit: "B" },
          { blade: "Thanos", ratchet: "4-60", bit: "P" }
        ]
      },
      {
        name: "Spider-Man & Venom (Dual Pack)",
        beys: [
          { blade: "Spider-Man", ratchet: "3-60", bit: "F" },
          { blade: "Venom", ratchet: "3-80", bit: "N" }
        ]
      },
      {
        name: "Optimus Prime & Megatron (Dual Pack)",
        beys: [
          { blade: "Optimus Prime", ratchet: "4-60", bit: "P" },
          { blade: "Megatron", ratchet: "4-80", bit: "B" }
        ]
      },
      {
        name: "Optimus Primal & Starscream (Dual Pack)",
        beys: [
          { blade: "Optimus Primal", ratchet: "3-60", bit: "F" },
          { blade: "Starscream", ratchet: "3-80", bit: "N" }
        ]
      },
      {
        name: "Mandolorian & Moff Gideon (Dual Pack)",
        beys: [
          { blade: "Mandolorian", ratchet: "3-80", bit: "F" },
          { blade: "Moff Gideon", ratchet: "3-80", bit: "N" }
        ]
      },
      {
        name: "Luke Skywalker & Darth Vader (Dual Pack)",
        beys: [
          { blade: "Luke Skywalker", ratchet: "4-80", bit: "B" },
          { blade: "Darth Vader", ratchet: "4-60", bit: "P" }
        ]
      },
      {
        name: "T-Rex & Mosasaurus (Dual Pack)",
        beys: [
          { blade: "T-Rex", ratchet: "1-80", bit: "GB" },
          { blade: "Mosasaurus", ratchet: "9-60", bit: "U" }
        ]
      },
      {
        name: "Spinosaurus & Quetzalcoatlus (Dual Pack)",
        beys: [
          { blade: "Spinosaurus", ratchet: "1-85", bit: "A" },
          { blade: "Quetzalcoatlus", ratchet: "4-55", bit: "D" }
        ]
      },
      { name: "Sword Dran (F9580)", beys: [{ blade: "Sword Dran", ratchet: "3-60", bit: "F" }] },
      { name: "Helm Knight (F9581)", beys: [{ blade: "Helm Knight", ratchet: "3-80", bit: "N" }] },
      { name: "Arrow Wizard (F9582)", beys: [{ blade: "Arrow Wizard", ratchet: "4-80", bit: "B" }] },
      { name: "Scythe Incendio (F9583)", beys: [{ blade: "Scythe Incendio", ratchet: "4-60", bit: "T" }] },
      { name: "Lance Knight (G0184)", beys: [{ blade: "Lance Knight", ratchet: "4-80", bit: "HN" }] },
      { name: "Claw Leon (G0193)", beys: [{ blade: "Claw Leon", ratchet: "5-60", bit: "P" }] },
      { name: "Courage Dran S (G1677)", assistBlade: "Slash", beys: [{ blade: "Courage Dran S", ratchet: "6-60", bit: "V" }] },
      { name: "Reaper Incendio T (G1678)", assistBlade: "Turn", beys: [{ blade: "Reaper Incendio T", ratchet: "4-70", bit: "K" }] },
      { name: "Arc Wizard R (G1679)", assistBlade: "Round", beys: [{ blade: "Arc Wizard R", ratchet: "4-55", bit: "LO" }] },
      { name: "Dark Perseus B (G1680)", assistBlade: "Bumper", beys: [{ blade: "Dark Perseus B", ratchet: "6-80", bit: "W" }] },
      { name: "Brush Fox J (G1681)", assistBlade: "Jaggy", beys: [{ blade: "Brush Fox J", ratchet: "9-70", bit: "GR" }] },
      { name: "Fort Hornet R (G1682)", beys: [{ blade: "Fort Hornet R", ratchet: "7-60", bit: "T" }] },
      { name: "Wriggle Kraken S (G1683)", beys: [{ blade: "Wriggle Kraken S", ratchet: "3-85", bit: "O" }] },
      { name: "Antler Stag B (G1684)", assistBlade: "Bumper", beys: [{ blade: "Antler Stag B", ratchet: "2-60", bit: "HN" }] },
      { name: "Steel Samurai (G0188)", beys: [{ blade: "Steel Samurai", ratchet: "4-80", bit: "T" }] },
      { name: "Horn Rhino (G0192)", beys: [{ blade: "Horn Rhino", ratchet: "3-80", bit: "S" }] },
      { name: "Keel Shark (G0194)", beys: [{ blade: "Keel Shark", ratchet: "3-60", bit: "LF" }] },
      { name: "Talon Ptera (G0195)", beys: [{ blade: "Talon Ptera", ratchet: "3-80", bit: "B" }] },
      { name: "Sting Unicorn (G0283)", beys: [{ blade: "Sting Unicorn", ratchet: "5-60", bit: "GP" }] },
      { name: "Roar Tyranno (G0284)", beys: [{ blade: "Roar Tyranno", ratchet: "9-60", bit: "GF" }] },
      { name: "Scythe Incendio (G0285)", beys: [{ blade: "Scythe Incendio", ratchet: "3-80", bit: "B" }] },
      { name: "Savage Bear (G0286)", beys: [{ blade: "Savage Bear", ratchet: "3-60", bit: "S" }] },
      { name: "Cowl Sphinx (G1530)", beys: [{ blade: "Cowl Sphinx", ratchet: "9-80", bit: "GN" }] },
      { name: "Arrow Wizard (G1531)", beys: [{ blade: "Arrow Wizard", ratchet: "4-80", bit: "GB" }] },
      { name: "Obsidian Shell (G1533)", beys: [{ blade: "Obsidian Shell", ratchet: "4-60", bit: "D" }] },
      { name: "Keel Shark (G1534)", beys: [{ blade: "Keel Shark", ratchet: "1-60", bit: "Q" }] },
      { name: "Tide Whale (G1669)", beys: [{ blade: "Tide Whale", ratchet: "5-80", bit: "E" }] },
      { name: "Dagger Dran (G1670)", beys: [{ blade: "Dagger Dran", ratchet: "4-70", bit: "Q" }] },
      { name: "Lance Knight (G1671)", beys: [{ blade: "Lance Knight", ratchet: "3-60", bit: "LF" }] },
      { name: "Yell Kong (G1754)", beys: [{ blade: "Yell Kong", ratchet: "3-60", bit: "GB" }] },
      { name: "Arrow Wizard (G1755)", beys: [{ blade: "Arrow Wizard", ratchet: "4-80", bit: "O" }] },
      { name: "Soar Phoenix (G1756)", beys: [{ blade: "Soar Phoenix", ratchet: "5-80", bit: "H" }] },
      { name: "Buster Dran (G1536)", beys: [{ blade: "Buster Dran", ratchet: "1-60", bit: "A" }] },
      { name: "Wand Wizard (G1537)", beys: [{ blade: "Wand Wizard", ratchet: "5-70", bit: "DB" }] },
      { name: "Wand Wizard (G1538)", beys: [{ blade: "Wand Wizard", ratchet: "1-60", bit: "R" }] },
      { name: "Shadow Shinobi (G1539)", beys: [{ blade: "Shadow Shinobi", ratchet: "1-80", bit: "MN" }] },
      { name: "Scarlet Garuda (G1673)", beys: [{ blade: "Scarlet Garuda", ratchet: "4-70", bit: "TP" }] },
      { name: "Sterling Wolf (G1674)", beys: [{ blade: "Sterling Wolf", ratchet: "3-80", bit: "FB" }] },
      { name: "Shelter Drake (G1675)", beys: [{ blade: "Shelter Drake", ratchet: "7-80", bit: "GP" }] },
      { name: "Rock Golem (G1676)", beys: [{ blade: "Rock Golem", ratchet: "1-60", bit: "UN" }] },
      { name: "Buster Dran (G1751)", beys: [{ blade: "Buster Dran", ratchet: "5-70", bit: "DB" }] },
      { name: "Hammer Incendio (G1752)", beys: [{ blade: "Hammer Incendio", ratchet: "3-70", bit: "H" }] },
      { name: "Stun Medusa (G2738)", beys: [{ blade: "Stun Medusa", ratchet: "9-60", bit: "GB" }] },
      { name: "Rudder Phoenix (G2739)", beys: [{ blade: "Rudder Phoenix", ratchet: "4-70", bit: "LF" }] },
      { name: "Feather Phoenix (G2740)", beys: [{ blade: "Feather Phoenix", ratchet: "2-60", bit: "N" }] },
      {
        name: "Chain Incendio & Arrow Wizard (Dual Pack)",
        beys: [
          { blade: "Chain Incendio", ratchet: "5-60", bit: "HT" },
          { blade: "Arrow Wizard", ratchet: "4-60", bit: "N" },
        ],
      },
      {
        name: "Knife Shinobi & Keel Shark (Dual Pack)",
        beys: [
          { blade: "Knife Shinobi", ratchet: "4-80", bit: "HN" },
          { blade: "Keel Shark", ratchet: "3-80", bit: "F" },
        ],
      },
      {
        name: "Yell Kong & Helm Knight (Dual Pack)",
        beys: [
          { blade: "Yell Kong", ratchet: "3-60", bit: "GB" },
          { blade: "Helm Knight", ratchet: "5-80", bit: "T" },
        ],
      },
      {
        name: "Pearl Tiger & Gill Shark (Dual Pack)",
        beys: [
          { blade: "Pearl Tiger", ratchet: "3-60", bit: "U" },
          { blade: "Gill Shark", ratchet: "4-70", bit: "O" },
        ],
      },
      {
        name: "Circle Ghost & Chain Incendio (Dual Pack)",
        beys: [
          { blade: "Circle Ghost", ratchet: "0-80", bit: "GB" },
          { blade: "Chain Incendio", ratchet: "5-60", bit: "HT" },
        ],
      },
      {
        name: "Hack Viking & Circle Ghost (Dual Pack)",
        beys: [
          { blade: "Circle Ghost", ratchet: "0-80", bit: "GB" },
        ],
      },
      {
        name: "Drop Attack Battle Set (G0842)",
        beys: [
          { blade: "Impact Drake", ratchet: "9-60", bit: "LR" },
          { blade: "Hover Wyvern", ratchet: "3-85", bit: "N" },
        ],
      },
    ];

    const bladeSelect = document.getElementById("blade-select");
    const assistSelect = document.getElementById("assist-select");
    const ratchetSelect = document.getElementById("ratchet-select");
    const bitSelect = document.getElementById("bit-select");
    const cxToggle = document.getElementById("cx-toggle");
    const assistField = document.getElementById("assist-field");
    const form = document.getElementById("bey-form");
    const results = document.getElementById("bey-results");
    const bladePreview = document.getElementById("blade-preview");
    const ratchetPreview = document.getElementById("ratchet-preview");
    const bitPreview = document.getElementById("bit-preview");

    if (
      form &&
      bladeSelect &&
      assistSelect &&
      ratchetSelect &&
      bitSelect &&
      results &&
      cxToggle &&
      assistField
    ) {
      const blades = new Set();
      const assists = new Set();
      const ratchets = new Set();
      const bits = new Set();

      const beys = products.reduce((acc, product) => {
        const assistBlade = product.assistBlade || "";
        product.beys.forEach((bey) => {
          acc.push({ ...bey, assistBlade, product: product.name });
        });
        return acc;
      }, []);

      beys.forEach((bey) => {
        blades.add(bey.blade);
        if (bey.assistBlade) {
          assists.add(bey.assistBlade);
        }
        ratchets.add(bey.ratchet);
        bits.add(bey.bit);
      });

      const sortedBlades = Array.from(blades).sort((a, b) =>
        a.localeCompare(b, "it")
      );
      const sortedAssists = Array.from(assists).sort((a, b) =>
        a.localeCompare(b, "it")
      );
      const sortedRatchets = Array.from(ratchets).sort((a, b) =>
        a.localeCompare(b, "it", { numeric: true })
      );
      const sortedBits = Array.from(bits).sort((a, b) => a.localeCompare(b, "it"));

      sortedBlades.forEach((blade) => {
        const option = document.createElement("option");
        option.value = blade;
        option.textContent = blade;
        bladeSelect.appendChild(option);
      });

      bladeSelect.addEventListener("change", () => {
        const url = bladeImage(bladeSelect.value);
        if (url) {
          bladePreview.src = url;
          bladePreview.classList.add("active");
        } else {
          bladePreview.removeAttribute("src");
          bladePreview.classList.remove("active");
        }
      });

      sortedAssists.forEach((assist) => {
        const option = document.createElement("option");
        option.value = assist;
        option.textContent = assist;
        assistSelect.appendChild(option);
      });

      const syncAssistVisibility = () => {
        if (cxToggle.checked) {
          assistField.classList.remove("is-hidden");
          assistSelect.disabled = false;
        } else {
          assistField.classList.add("is-hidden");
          assistSelect.value = "";
          assistSelect.disabled = true;
        }
      };

      cxToggle.addEventListener("change", syncAssistVisibility);
      syncAssistVisibility();

      sortedRatchets.forEach((ratchet) => {
        const option = document.createElement("option");
        option.value = ratchet;
        option.textContent = ratchet;
        ratchetSelect.appendChild(option);
      });

      ratchetSelect.addEventListener("change", () => {
        const url = ratchetImage(ratchetSelect.value);
        if (url) {
          ratchetPreview.src = url;
          ratchetPreview.classList.add("active");
        } else {
          ratchetPreview.removeAttribute("src");
          ratchetPreview.classList.remove("active");
        }
      });

      sortedBits.forEach((bit) => {
        const option = document.createElement("option");
        option.value = bit;
        option.textContent = bit;
        bitSelect.appendChild(option);
      });

      bitSelect.addEventListener("change", () => {
        const url = bitImage(bitSelect.value);
        if (url) {
          bitPreview.src = url;
          bitPreview.classList.add("active");
        } else {
          bitPreview.removeAttribute("src");
          bitPreview.classList.remove("active");
        }
      });

      form.addEventListener("submit", (event) => {
        event.preventDefault();

        const blade = bladeSelect.value.trim();
        const assistBlade = cxToggle.checked ? assistSelect.value.trim() : "";
        const ratchet = ratchetSelect.value.trim();
        const bit = bitSelect.value.trim();
        const requested = { blade, assistBlade, ratchet, bit };
        const hasRequest = Object.values(requested).some(Boolean);

        if (!hasRequest) {
          results.innerHTML = `
            <h2>Risultato</h2>
            <p class="muted">Seleziona almeno un pezzo per cercare.</p>
          `;
          return;
        }

        const candidates = beys.filter(
          (bey) =>
            (blade && bey.blade === blade) ||
            (assistBlade && bey.assistBlade === assistBlade) ||
            (ratchet && bey.ratchet === ratchet) ||
            (bit && bey.bit === bit)
        );

        const comboKeys = new Set();
        const combos = [];

        const coversTarget = (combo) => ({
          blade: !blade || combo.some((bey) => bey.blade === blade),
          assistBlade:
            !assistBlade || combo.some((bey) => bey.assistBlade === assistBlade),
          ratchet: !ratchet || combo.some((bey) => bey.ratchet === ratchet),
          bit: !bit || combo.some((bey) => bey.bit === bit),
        });

        const pushCombo = (combo) => {
          const key = combo
            .map(
              (bey) =>
                `${bey.product}|${bey.blade}|${bey.assistBlade}|${bey.ratchet}|${bey.bit}`
            )
            .sort()
            .join("||");
          if (!comboKeys.has(key)) {
            comboKeys.add(key);
            combos.push(combo);
          }
        };

        const maxBeys = cxToggle.checked ? 4 : 3;

        const buildCombos = (startIndex, current) => {
          if (current.length > 0) {
            const cover = coversTarget(current);
            if (cover.blade && cover.assistBlade && cover.ratchet && cover.bit) {
              pushCombo(current);
            }
          }

          if (current.length === maxBeys) {
            return;
          }

          for (let i = startIndex; i < candidates.length; i += 1) {
            buildCombos(i + 1, [...current, candidates[i]]);
          }
        };

        buildCombos(0, []);

        combos.sort((a, b) => a.length - b.length);

        if (combos.length === 0) {
          results.innerHTML = `
            <h2>Risultato</h2>
            <p class="muted">Nessuna combinazione trovata con massimo 3 bey.</p>
          `;
          return;
        }

        const maxOptions = 12;
        const shown = combos.slice(0, maxOptions);
        const optionHtml = shown
          .map((combo, index) => {
            const items = combo
              .map((bey) => {
                const productUrl =
                  productLinks[bey.product] ||
                  "https://www.amazon.it/beyblade-x-starter-pack/s?k=beyblade+x+starter+pack&utm_source=chatgpt.com";
                const bladeUrl = bladeImage(bey.blade);
                const ratchetUrl = ratchetImage(bey.ratchet);
                const bitUrl = bitImage(bey.bit);

                return `
                  <div class="result-pill">
                    <div class="result-row">
                      <div class="result-meta">
                        <div>${bey.blade} (${bey.ratchet}${bey.bit})</div>
                        ${bey.assistBlade ? `<div class="pill-note">Assist blade: ${bey.assistBlade}</div>` : ``}
                        <div class="part-row">
                          ${bladeUrl ? `<img class="part-icon" src="${bladeUrl}" alt="Lama ${bey.blade}" />` : ``}
                          ${ratchetUrl ? `<img class="part-icon" src="${ratchetUrl}" alt="Ratchet ${bey.ratchet}" />` : ``}
                          ${bitUrl ? `<img class="part-icon" src="${bitUrl}" alt="Punta ${bey.bit}" />` : ``}
                        </div>
                        <span class="pill-note">Prodotto: ${bey.product}</span>
                        <a class="result-link" href="${productUrl}" target="_blank" rel="noreferrer">Apri link</a>
                      </div>
                    </div>
                  </div>
                `;
              })
              .join("");
            return `
              <div class="result-combo">
                <p class="combo-title">Opzione ${index + 1} Â· ${combo.length} bey</p>
                <div class="result-list">${items}</div>
              </div>
            `;
          })
          .join("");

        const extraNote =
          combos.length > maxOptions
            ? `<p class="muted">Altre ${combos.length - maxOptions} opzioni disponibili.</p>`
            : "";
        results.innerHTML = `
          <h2>Risultato</h2>
          <p>Risultati per <strong>${[blade, assistBlade, ratchet, bit].filter(Boolean).join(" ")}</strong> (max ${maxBeys}):</p>
          ${optionHtml}
          ${extraNote}
        `;
      });
    }
  </script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import {
      getAuth,
      onAuthStateChanged,
      createUserWithEmailAndPassword,
      signInWithEmailAndPassword,
      signOut
    } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyABecShIp74jQSTjYiT-i2eAmcjBz1NJ8g",
      authDomain: "progettobey.firebaseapp.com",
      projectId: "progettobey",
      storageBucket: "progettobey.firebasestorage.app",
      messagingSenderId: "736351155639",
      appId: "1:736351155639:web:6b2f911e333a0ba3d1a432",
      measurementId: "G-ENM35CJKKR"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);

    const authMessage = document.getElementById("auth-message");
    const emailForm = document.getElementById("email-form");
    const emailInput = document.getElementById("email-input");
    const passwordInput = document.getElementById("password-input");
    const emailRegisterBtn = document.getElementById("email-register");
    const logoutBtn = document.getElementById("logout-btn");

    const setAuthMessage = (message, isError = false) => {
      authMessage.textContent = message;
      authMessage.style.color = isError ? "#ff6a6a" : "var(--muted)";
    };

    onAuthStateChanged(auth, (user) => {
      if (user) {
        logoutBtn.classList.remove("is-hidden");
        setAuthMessage(`Sei loggato come ${user.email || user.phoneNumber}.`);
      } else {
        logoutBtn.classList.add("is-hidden");
        setAuthMessage("");
      }
    });

    emailForm.addEventListener("submit", async (event) => {
      event.preventDefault();
      setAuthMessage("");
      try {
        await signInWithEmailAndPassword(
          auth,
          emailInput.value.trim(),
          passwordInput.value
        );
      } catch (error) {
        setAuthMessage("Login email fallito. Controlla i dati.", true);
      }
    });

    emailRegisterBtn.addEventListener("click", async () => {
      setAuthMessage("");
      try {
        await createUserWithEmailAndPassword(
          auth,
          emailInput.value.trim(),
          passwordInput.value
        );
      } catch (error) {
        setAuthMessage("Registrazione email fallita. Controlla i dati.", true);
      }
    });


    logoutBtn.addEventListener("click", async () => {
      await signOut(auth);
    });
  </script>
</body>
</html>
